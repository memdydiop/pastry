<?php

use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Session;
use App\Livewire\Forms\ProfileForm;
use Livewire\Volt\Component;
use Livewire\WithFileUploads;

new class extends Component {

    use WithFileUploads;

    public ProfileForm $form;

    /**
     * Mount the component and populate the form
     * with the authenticated user's profile data.
     */
    public function mount(): void
    {
        $this->form->fill(
            auth()->user()->profile->only(
                'full_name',
                'date_of_birth',
                'phone',
                'address',
                'city',
                'country',
                'bio'
            )
        );

        // We need to format the date correctly for the HTML input
        if (auth()->user()->profile->date_of_birth) {
            $this->form->date_of_birth = auth()->user()->profile->date_of_birth->format('Y-m-d');
        }
    }

    /**
     * Update the profile information.
     */
    public function updateProfile(): void
    {
        $data = $this->form->validate();

        if ($this->form->avatar) {
            $data['avatar'] = $this->form->avatar->store('avatars', 'public');
        }

        auth()->user()->profile()->update($data);

        // Dispatch a browser event for the toast notification
        $this->dispatch('profile-updated');
    }

    /**
     * Send an email verification notification to the current user.
     */
    public function resendVerificationNotification(): void
    {
        $user = Auth::user();

        if ($user->hasVerifiedEmail()) {
            $this->redirectIntended(default: route('dashboard', absolute: false));

            return;
        }

        $user->sendEmailVerificationNotification();

        Session::flash('status', 'verification-link-sent');
    }
}; ?>
    <x-layouts.content  
    :heading="__('Setting')" 
    :subheading="__('Update your profile')" 
    :pageHeading="__('Profil')" 
    :pageSubheading="__('Mettez à jour les informations de votre profil et votre avatar.')">

        <form wire:submit="updateProfile" class="my-6 w-full space-y-6">

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-6">
                <!-- Avatar Section -->
                <div class="col-span-full flex items-center gap-x-8">
                    @if ($form->avatar)
                        <!-- Preview of the new avatar -->
                        <img src="{{ $form->avatar->temporaryUrl() }}" alt="Aperçu de l'avatar"
                            class="h-24 w-24 flex-none rounded-lg bg-gray-800 object-cover">
                    @else
                        <!-- Current avatar -->
                        <img src="{{ auth()->user()->avatar }}" alt="Avatar actuel"
                            class="h-24 w-24 flex-none rounded-lg bg-gray-800 object-cover">
                    @endif
                    <div>
                        <flux:button type="button" label="Changer l'avatar" onclick="$refs.avatarInput.click()" />
                        <p class="mt-2 text-xs leading-5 text-gray-400">JPG, GIF or PNG. 2MB max.</p>
                    </div>
                    {{-- <input type="file" wire:model.live="form.avatar" x-ref="avatarInput" class=""> --}}
                    <flux:input type="file" wire:model.live="form.avatar"  x-ref="avatarInput" class="hidden" />
                    @error('form.avatar') <span class="text-red-500 text-sm mt-2">{{ $message }}</span> @enderror
                </div>
            
                <!-- Form Fields -->
                <div class="sm:col-span-3">
                    <flux:input wire:model.live="form.full_name" :label="__('Name')" type="text" required autofocus autocomplete="full_name" />
                </div>
                <div class="sm:col-span-3">
                    <flux:input wire:model.live="form.date_of_birth" type="date" label="Date de naissance" />
                </div>
                <div class="sm:col-span-3">
                    <flux:input wire:model.live="form.phone" label="Téléphone" />
                </div>
                <div class="sm:col-span-3">
                    <flux:input wire:model.live="form.address" label="Adresse" />
                </div>
                <div class="sm:col-span-3">
                    <flux:input wire:model.live="form.city" label="Ville" />
                </div>
                <div class="sm:col-span-3">
                    <flux:input wire:model.live="form.country" label="Pays" />
                </div>
                <div class="col-span-full">
                    <flux:textarea wire:model.live="form.bio" label="Bio" />
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center justify-end">
                    <flux:button variant="success" type="submit" class="w-full" data-test="update-profile-button">
                        {{ __('Save') }}
                    </flux:button>
                </div>

                <x-action-message class="me-3" on="profile-updated">
                    {{ __('Saved.') }}
                </x-action-message>
            </div>
        </form>

        <livewire:settings.delete-user-form />
    </x-layouts.content >
